{% extends "base.html" %}
{% block title %}Course Analytics - Faculty{% endblock %}
{% block content %}
<div class="dashboard-container">
    <h1>Course Enrollment Analytics</h1>
    <p class="lead">Read-only. Limited to your assigned courses and department. No institution-wide data.</p>

    <div class="dashboard-section">
        <h2>Course-wise Enrollment (Assigned Only)</h2>
        <table class="data-table">
            <thead>
                <tr><th>Course Name</th><th>Code</th><th>Department</th><th>Enrollment Count</th></tr>
            </thead>
            <tbody>
                {% for r in course_data %}
                <tr><td>{{ r.course_name }}</td><td>{{ r.course_code }}</td><td>{{ r.department }}</td><td>{{ r.enrollment_count }}</td></tr>
                {% else %}<tr><td colspan="4">No data.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <div class="dashboard-section">
        <h2>Seat Utilization % (Assigned Courses)</h2>
        <table class="data-table">
            <thead>
                <tr><th>Course</th><th>Code</th><th>Enrolled</th><th>Seat Limit</th><th>Utilization %</th></tr>
            </thead>
            <tbody>
                {% for u in utilization_list %}
                <tr>
                    <td>{{ u.course_name }}</td><td>{{ u.course_code }}</td>
                    <td>{{ u.enrolled }}</td><td>{{ u.seat_limit or '—' }}</td>
                    <td>{{ u.utilization_pct }}%</td>
                </tr>
                {% else %}<tr><td colspan="5">No data.</td></tr>{% endfor %}
            </tbody>
        </table>
        <canvas id="utilChart" height="100"></canvas>
    </div>

    <div class="dashboard-section">
        <h2>Department-Level Summary (Your Department Only)</h2>
        <table class="data-table">
            <thead>
                <tr><th>Department</th><th>Code</th><th>Enrollment Count</th></tr>
            </thead>
            <tbody>
                {% for r in dept_data %}
                <tr><td>{{ r.department_name }}</td><td>{{ r.department_code }}</td><td>{{ r.enrollment_count }}</td></tr>
                {% else %}<tr><td colspan="3">No data.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <div class="dashboard-section">
        <h2>Enrollment Trend</h2>
        <canvas id="trendsChart" height="100"></canvas>
        {% if not trends_data %}<p class="text-muted">No trend data yet.</p>{% endif %}
    </div>

    <div class="dashboard-section">
        <h2>High-Demand vs Low-Enrollment (Within Your Courses)</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h3>High Demand</h3>
                <table class="data-table">
                    <thead><tr><th>Course</th><th>Count</th></tr></thead>
                    <tbody>
                        {% for r in high_demand %}
                        <tr><td>{{ r.course_name }} ({{ r.course_code }})</td><td>{{ r.enrollment_count }}</td></tr>
                        {% else %}<tr><td colspan="2">—</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
            <div>
                <h3>Low Enrollment</h3>
                <table class="data-table">
                    <thead><tr><th>Course</th><th>Count</th></tr></thead>
                    <tbody>
                        {% for r in low_demand %}
                        <tr><td>{{ r.course_name }} ({{ r.course_code }})</td><td>{{ r.enrollment_count }}</td></tr>
                        {% else %}<tr><td colspan="2">—</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
(function(){
    var util = {{ utilization_list|tojson }};
    if (util.length && document.getElementById('utilChart')) {
        new Chart(document.getElementById('utilChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: util.map(function(u){ return u.course_code; }),
                datasets: [{ label: 'Utilization %', data: util.map(function(u){ return u.utilization_pct; }), backgroundColor: 'rgba(75,192,192,0.6)' }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }
    var trends = {{ trends_data|tojson }};
    if (trends.length && document.getElementById('trendsChart')) {
        new Chart(document.getElementById('trendsChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: trends.map(function(t){ return t.date; }),
                datasets: [{ label: 'Enrollments', data: trends.map(function(t){ return t.count; }), borderColor: 'rgba(75,192,192,1)', tension: 0.1 }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
})();
</script>
{% endblock %}
